<HTML>
  <HEAD>
    <TITLE>Multiboot plan</TITLE>
    <meta name="keywords" content="CapROS, Multiboot, GRUB">
  </HEAD>
  <BODY BGCOLOR="#fff0ff" text="#000000" link="#0000ee" vlink="#551a8b" alink="#ff0000">
    <center>
      <H1>A Plan for Booting CapROS using Multiboot</H1>
    </center>
    <p>
    <a href=""></a>
    </p>
    <p>
    <a href="http://sourceforge.net/mailarchive/message.php?msg_id=11700357">
    This email thread</a> suggests changing CapROS to use the
    Multiboot specification supported by the GRUB boot loader. 
    Here is how I think that can be done.
    </p>
    <p>
    First, a Multiboot header must be included near the beginning of
    the kernel image.
    This could be in lostart.S. 
    (I don't know how GRUB locates the Multiboot header; perhaps by
    searching for the magic number?) 
    </p>
    <p>
    GRUB likes to load from a filesystem, so as an interim measure, we will put
    the things to be loaded into files located wherever GRUB is loading from
    (disk, floppy, net, etc.). 
    For the following we assume we are loading from a hard disk.
    The disk should have a partition with a VFAT file system
    mounted at /boot. The system generation process will put the following
    files into /boot:
    <ul>
      <li>CapROS-kernel-0: an image of the kernel. It does not have OIDs
      or page pots. "0" is a version number.
      <li>CapROS-PL-nnnn: A preloaded range, as it would exist on disk,
      with page pots. 
      nnnn is the hex starting OID, for uniqueness. 
      <li>CapROS-config: This file is loaded with the GRUB "configfile"
      command. It contains commands to load the kernel and the modules it
      requires, including "command line" parameters (see below).
      A CapROS tool, perhaps <b>mkvol</b>, would construct the 
      configuration file.
    </ul>
    </p>
    <p>
    <b>setboot</b> would no longer be needed.
    </p>
    <p>
    To maintain consistency, there needs to be a primary config file
    (referring to the primary kernel and preloaded files)
    and a secondary config file 
    referring to the secondary kernel and preloaded files.
    You keep one set consistent and unchanged while (non-atomically)
    updating the other set. 
    </p>
    <p>
    (We could write to the kernel file the kernel a.out or ELF
    file (which GRUB understands), but we won't, we'll continue
    using an image file.)
    </p>
    <p>
    We will drop support for booting from RAM disk. 
    </p>
    <p>
    The Multiboot specification provides some, but not all, of the information
    the kernel currently gets in the BootInfo structure. (I'm assuming that
    GRUB actually provides all the information specified as optional
    in the Multiboot specification, but I haven't verified this.)
    The following fields in BootInfo have issues:
    </p>
    <ul>
      <li>memInfo: GRUB provides information on available RAM.
      The kernel now uses only this information.
      <li>divInfo.startOid: This can be passed 
      in the string given with the GRUB "module" command. 
      <li>divInfo.endOid: This is now calculated from the startOid and the size. 
      <li>consInfo: not currently used by the kernel
      <li>volFlags.VF_DEBUG: This should be passed in the
      GRUB "command line" string.
      <li>iplKey: the OID of the process to start can be passed in the
      GRUB "command line" string.
      <li>iplSysId: The kernel could get this from the disk driver when 
      it reads the VolHdr of the booted disk. (It's currently not used
      because the disk logic is incomplete.)
      <li>bootDrive: The Multiboot specification provides the boot_device,
      but it is the partition containing the OS image,
      which is in the /boot file system,
      not the CapROS partition. We'll have to pass the information
      in the "command line" string.
      bootDrive is currently unused but will be needed by the code
      to discover iplSysId.
      <li>bootStartSec, isRamImage: only used during boot, not used by the kernel
    </ul>
    <hr>
<table>
<tr valign=top>
  <td width=92>
<a href="http://sourceforge.net"><img src="http://sourceforge.net/sflogo.php?group_id=132228&amp;type=1" width="88" height="31" border="0" alt="SourceForge.net Logo" /></a>
  </td>
  <td>
    Authored by Charles Landau. <br>
      <em>Copyright 2005 by Strawberry Development Group.  All rights reserved.
      For terms of redistribution, see the <a
      href="./legal/license/GPL.html">GNU General Public License</a></em>
   </td>
</tr>
</table>
  </BODY>
</html>
