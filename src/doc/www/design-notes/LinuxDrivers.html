<html>
  <head>
    <title>Supporting Linux Device Drivers</title>
  </head>
  <BODY BGCOLOR="#fff0ff" text="#000000" link="#0000ee" vlink="#551a8b" alink="#ff0000">
  <center>
    <h1 class="title">Supporting Linux Device Drivers</h1>
  </center>
    <h1>Configuration</h1>
    <p>
      File base/lib/linux-headers/linux/autoconf.h is taken from a
      configured Linux kernel. It should have the Preemptible Kernel
      option selected, as that most closely approximates the
      emulation environment, which has independent processes. 
    </p>
    <p>
      The SMP option might also be useful, but there doesn't seem
      to be a way to select it for ARM EP93xx using menuconfig.
    </p>
    <h1>Externals Needed</h1>
    <p>
      (This is not on the web yet because it is not ready for prime time.)
    </p>
    <p>
      Following are symbols referenced from drivers/serial/amba-pl010.o
      and defined in drivers/serial/serial_core.c.
    </p>
    <table>
  <tr> <td valign="top"><code>uart_add_one_port</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>uart_get_baud_rate</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>uart_get_divisor</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>uart_register_driver</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>uart_remove_one_port</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>uart_resume_port</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>uart_suspend_port</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>uart_unregister_driver</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>uart_update_timeout</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>uart_write_wakeup</code></td> <td>
  </td></tr>
    </table>
    <p>
      Following are symbols referenced from drivers/serial/amba-pl010.o
      and defined as inline procedures in drivers/serial/serial_core.h.
    </p>
    <table>
  <tr> <td valign="top"><code>do_SAK</code></td> <td>
    From inline proc uart_handle_break, only if (port-&gt;flags &amp; UPF_SAK).
    Secure attention key will be handled at a higher level.
  </td></tr>
  <tr> <td valign="top"><code>tty_hangup</code></td> <td>
    Part of static procedure uart_handle_dcd_change. 
    This seems to disconnect the serial port from the user.
    This will be handled at a higher level.
  </td></tr>
    </table>
    <p>
      Following are all other symbols referenced from drivers/serial/amba-pl010.o.
    </p>
    <h2>Clock Control</h2>
    <table>
  <tr> <td valign="top"><code>clk_disable</code></td> <td>
    From arch/arm/mach-ep93xx/clock.o. This file could be linked in,
    but for proper locking it may need to be a separate object. 
    It requires only printk() and some libc procedures. 
    On ep93xx, tracks users but otherwise does nothing.
  </td></tr>
  <tr> <td valign="top"><code>clk_enable</code></td> <td>
    From arch/arm/mach-ep93xx/clock.o.
    On ep93xx, tracks users but otherwise does nothing.
  </td></tr>
  <tr> <td valign="top"><code>clk_get</code></td> <td>
    From arch/arm/mach-ep93xx/clock.o. Look up clk structure for "UARTCLK". 
  </td></tr>
  <tr> <td valign="top"><code>clk_get_rate</code></td> <td>
    From arch/arm/mach-ep93xx/clock.o.
    On ep93xx, returns the UART clock rate of 14,745,600.
  </td></tr>
  <tr> <td valign="top"><code>clk_put</code></td> <td>
    From arch/arm/mach-ep93xx/clock.o. Does nothing on ep93xx.
  </td></tr>
    </table>
    <h2>Device Registers</h2>
    <p>Following POLA, I would like to grant access to
       only the page(s) needed. If the big bang grants access to only
       one process, request/release_mem_region can be nops.</p>
    <table>
  <tr> <td valign="top"><code>iomem_resource</code></td> <td>
    Part of request_mem_region(). Structure used to map device registers. 
  </td></tr>
  <tr> <td valign="top"><code>__arm_ioremap</code></td> <td>
    From arch/arm/mm/built-in.o. Part of ioremap(). 
  </td></tr>
  <tr> <td valign="top"><code>__iounmap</code></td> <td>
    Part of iounmap(). Used to unmap device registers? 
  </td></tr>
  <tr> <td valign="top"><code>__release_region</code></td> <td>
    Part of release_mem_region(). Used to unmap device registers?
  </td></tr>
  <tr> <td valign="top"><code>__request_region</code></td> <td>
    Part of request_mem_region(). Used to map device registers. 
  </td></tr>
    </table>
    <h2>IRQ Control</h2>
    <p>The plan is to create a thread to execute the interrupt handler.</p>
    <table>
  <tr> <td valign="top"><code>free_irq</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>request_irq</code></td> <td>
  </td></tr>
    </table>
    <h2>Memory Allocation</h2>
    <p>.</p>
    <table>
  <tr> <td valign="top"><code>kfree</code></td> <td>
    amba_pl010.c only calls kfree at remove time.
  </td></tr>
  <tr> <td valign="top"><code>kzalloc</code></td> <td>
    kzalloc is defined to call __kzalloc, which calls kmalloc_track_caller
    and then sets the memory to zero.
    kmalloc_track_caller just calls __kmalloc (unless configured for
    debugging). We will reimplement __kmalloc.
    <p>amba_pl010.c only calls kzalloc to allocate a structure at probe time,
    it uses the GFP_KERNEL flag, and it doesn't require
    contigous physical addresses.
  </td></tr>
  <tr> <td valign="top"><code>__kzalloc</code></td> <td>
    Use Linux implementation at mm/util.c.
  </td></tr>
  <tr> <td valign="top"><code>kmalloc_caches</code></td> <td>
    Data item for kzalloc.
  </td></tr>
  <tr> <td valign="top"><code>kmem_cache_zalloc</code></td> <td>
    Procedure for kzalloc. 
  </td></tr>
    </table>
    <h2>Spinlocks</h2>
    <p>Spinlocks will become mutexes (semaphores).</p>
    <table>
  <tr> <td valign="top"><code>spin_lock</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>spin_unlock</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>spin_lock_irqsave</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>spin_unlock_irqrestore</code></td> <td>
  </td></tr>
    </table>
    <h2>Tty flip buffer</h2>
    <table>
  <tr> <td valign="top"><code>tty_flip_buffer_push</code></td> <td>
    Ensure the buffered input is sent to the consumer
    (the line discipline), either immediately or delayed. 
  </td></tr>
  <tr> <td valign="top"><code>tty_insert_flip_string_flags</code></td> <td>
    Part of inline procedure tty_insert_flip_char, part of uart_inser_char,
    which inserts an input character and flag and possibly overrun
    into the receive buffer. 
    The character and flag are buffered in parallel.
  </td></tr>
    </table>
    <h2>Wait Queues</h2>
    <table>
  <tr> <td valign="top"><code>__wake_up</code></td> <td>
    Part of wake_up_interruptible(), used in pl010_modem_status
    and also part of static procedure uart_handle_dcd_change. 
  </td></tr>
    </table>
    <h2>Other</h2>
    <table>
  <tr> <td valign="top"><code>amba_driver_register</code></td> <td>
    From drivers/built-in.o. 
  </td></tr>
  <tr> <td valign="top"><code>amba_driver_unregister</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>printk</code></td> <td>
    For KERN_INFO message at init time. We can nop this for now. 
  </td></tr>
    </table>
    <p>
      Following are symbols referenced from drivers/serial/built-in.o,
      excluding symbols in libc and symbols listed above.
    </p>
    <table>
  <tr> <td valign="top"><code>add_wait_queue</code></td> <td>
    From kernel/built-in.o. 
  </td></tr>
  <tr> <td valign="top"><code>alloc_tty_driver</code></td> <td>
    From drivers/built-in.o. 
  </td></tr>
  <tr> <td valign="top"><code>__bug</code></td> <td>
    From arch/arm/kernel/built-in.o(traps.o). Prints a bug message.
  </td></tr>
  <tr> <td valign="top"><code>capable</code></td> <td>
    From kernel/built-in.o. 
  </td></tr>
  <tr> <td valign="top"><code>__copy_from_user</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>__copy_to_user</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>default_wake_function</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>dump_stack</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>free_pages</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>get_zeroed_page</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>init_waitqueue_head</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>jiffies</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>jiffies_to_msecs</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>__memzero</code></td> <td>
    From arch/arm/lib/lib.a(memzero.o). 
  </td></tr>
  <tr> <td valign="top"><code>msecs_to_jiffies</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>msleep</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>msleep_interruptible</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>__mutex_init</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>mutex_lock</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>mutex_lock_interruptible</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>mutex_unlock</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>put_tty_driver</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>__put_user_4</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>register_console</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>remove_wait_queue</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>schedule</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>strlcpy</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>tasklet_init</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>tasklet_kill</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>__tasklet_schedule</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>tty_hung_up_p</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>tty_ldisc_flush</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>tty_name</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>tty_register_device</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>tty_register_driver</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>tty_set_operations</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>tty_std_termios</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>tty_termios_baud_rate</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>tty_unregister_device</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>tty_unregister_driver</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>tty_vhangup</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>tty_wait_until_sent</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>tty_wakeup</code></td> <td>
  </td></tr>
  <tr> <td valign="top"><code>__udivsi3</code></td> <td>
    From arch/arm/lib/lib.a(lib1funcs.o).
  </td></tr>
    </table>
  <hr>
<table>
<tr valign=top>
  <td width=92>
<a href="http://sourceforge.net"><img src="http://sourceforge.net/sflogo.php?group_id=132228&amp;type=1" width="88" height="31" border="0" alt="SourceForge.net Logo" /></a>
  </td>
  <td>
      <em>Copyright 2007 by Strawberry Development Group.
      All rights reserved.
      For terms of redistribution, see the <a
      href="./legal/license/GPL.html">GNU General Public License</a></em>
This material is based upon work supported by the US Defense Advanced
Research Projects Agency under Contract No. W31P4Q-07-C-0070.
Approved for public release, distribution unlimited.
   </td>
</tr>
</table>
  </body>
</html>
